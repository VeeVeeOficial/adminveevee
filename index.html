<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeeVee Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, query, orderBy, limit, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // ‚ö†Ô∏è Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAlUUr6ATEfDQohr5Zvdk5_C7xKJFBLem0",
            authDomain: "veeveeweb.firebaseapp.com",
            projectId: "veeveeweb",
            storageBucket: "veeveeweb.firebasestorage.app",
            messagingSenderId: "105473827182",
            appId: "1:105473827182:web:d91d4b3bb2e91d8f456a3b"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Firebase ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            console.log('üî• Firebase App initialized:', app.name);
            console.log('üî• Firebase Auth initialized:', auth.app.name);

            // ‚úÖ Export ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á window ‡∏û‡∏£‡πâ‡∏≠‡∏° error handling
            window.firebaseDb = db;
            window.firebaseAuth = auth;
            window.firebaseCollection = collection;
            window.firebaseGetDocs = getDocs;
            window.firebaseAddDoc = addDoc;
            window.firebaseDoc = doc;
            window.firebaseUpdateDoc = updateDoc;
            window.firebaseDeleteDoc = deleteDoc;
            window.firebaseQuery = query;
            window.firebaseOrderBy = orderBy;
            window.firebaseLimit = limit;
            window.firebaseWhere = where;
            window.firebaseServerTimestamp = serverTimestamp;
            window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
            window.firebaseSignOut = signOut;
            
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç onAuthStateChanged ‡∏û‡∏£‡πâ‡∏≠‡∏° error handling
            window.firebaseOnAuthStateChanged = function(auth, callback) {
                try {
                    return onAuthStateChanged(auth, callback);
                } catch (error) {
                    console.error('‚ùå Firebase onAuthStateChanged error:', error);
                    // ‚úÖ Fallback: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å callback ‡∏î‡πâ‡∏ß‡∏¢ null user
                    setTimeout(() => callback(null), 100);
                    return () => {}; // Return empty unsubscribe function
                }
            };

            // ‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Firebase Auth
            window.firebaseOnAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log('‚úÖ Firebase Auth: User is signed in:', user.email);
                    
                    // ‚úÖ Trigger Alpine.js ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                    if (window.Alpine && window.Alpine.store) {
                        setTimeout(() => {
                            const adminApp = document.querySelector('[x-data="adminApp"]');
                            if (adminApp && adminApp._x_dataStack) {
                                const data = adminApp._x_dataStack[0];
                                if (data) {
                                    data.isAuthenticated = true;
                                    data.userEmail = user.email;
                                    console.log('‚úÖ Admin state updated via Alpine');
                                    
                                    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    if (typeof data.loadAllData === 'function') {
                                        data.loadAllData();
                                    }
                                }
                            }
                        }, 500);
                    }
                } else {
                    console.log('üö™ Firebase Auth: User is signed out');
                }
            });

            console.log('‚úÖ Firebase Admin initialized successfully');

        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            
            // ‚úÖ Fallback: Mock Firebase functions
            window.firebaseDb = null;
            window.firebaseAuth = null;
            window.firebaseOnAuthStateChanged = function(auth, callback) {
                console.warn('‚ö†Ô∏è Firebase not available, using fallback');
                setTimeout(() => callback(null), 100);
                return () => {};
            };
            
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö');
        }
    </script>

    <style>
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease-out;
        }
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .loading {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-50" x-data="adminApp">
    
    <!-- Login Screen -->
    <div x-show="!isAuthenticated" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-400 to-blue-500">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">VeeVee Admin</h1>
                <p class="text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</p>
            </div>
            
            <form @submit.prevent="login" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" x-model="loginForm.email" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" x-model="loginForm.password" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                
                <button type="submit" :disabled="loginLoading"
                        class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors disabled:opacity-50 flex items-center justify-center">
                    <span x-show="!loginLoading">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    <span x-show="loginLoading" class="flex items-center">
                        <div class="loading mr-2"></div>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...
                    </span>
                </button>
            </form>
            
            <div x-show="loginError" x-text="loginError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div x-show="isAuthenticated" class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-gray-900">VeeVee Admin</h1>
                        <span class="ml-4 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                            ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button @click="openGoogleSheets()" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition-colors text-sm">
                            üìä Google Sheets
                        </button>
                        <span class="text-gray-700" x-text="'‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ' + userEmail"></span>
                        <button @click="logout" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8 overflow-x-auto">
                    <button @click="currentTab = 'pos'" 
                            :class="currentTab === 'pos' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <i class="fas fa-cash-register mr-2"></i>‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (POS)
                        <span class="ml-2 bg-green-100 text-green-800 text-xs rounded-full px-2 py-1">‡πÄ‡∏õ‡∏¥‡∏î</span>
                    </button>
                    
                    <button @click="currentTab = 'products'" 
                            :class="currentTab === 'products' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <i class="fas fa-box mr-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        <span class="ml-2 bg-blue-100 text-blue-800 text-xs rounded-full px-2 py-1" x-text="products.length"></span>
                    </button>
                    
                    <button @click="currentTab = 'orders'" 
                            :class="currentTab === 'orders' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <i class="fas fa-shopping-cart mr-2"></i>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                        <span class="ml-2 bg-blue-100 text-blue-800 text-xs rounded-full px-2 py-1" x-text="orders.length"></span>
                    </button>
                    
                    <button @click="currentTab = 'contacts'" 
                            :class="currentTab === 'contacts' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <i class="fas fa-envelope mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
                        <span class="ml-2 bg-blue-100 text-blue-800 text-xs rounded-full px-2 py-1" x-text="contacts.length"></span>
                    </button>
                    
                    <button @click="currentTab = 'slips'" 
                            :class="currentTab === 'slips' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <i class="fas fa-receipt mr-2"></i>‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô
                        <span class="ml-2 bg-blue-100 text-blue-800 text-xs rounded-full px-2 py-1" x-text="paymentSlips.length"></span>
                    </button>
                    
                    <button @click="currentTab = 'reports'" 
                            :class="currentTab === 'reports' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <i class="fas fa-chart-line mr-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                    </button>
                    
                    <button @click="currentTab = 'inventory'" 
                            :class="currentTab === 'inventory' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        <i class="fas fa-warehouse mr-2"></i>‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        <span class="ml-2 bg-yellow-100 text-yellow-800 text-xs rounded-full px-2 py-1" x-text="getTotalStock()"></span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            
            <!-- POS System Tab -->
            <div x-show="currentTab === 'pos' && !loading">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Product Selection -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                            
                            <!-- Search Bar -->
                            <div class="mb-4">
                                <input type="text" x-model="posSearch" @input="filterProducts" 
                                       placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            
                            <!-- Product Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <template x-for="product in filteredProducts" :key="product.id">
                                    <div @click="addToCart(product)" 
                                         class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all">
                                        <div class="text-center">
                                            <div class="w-16 h-16 bg-green-100 rounded-full mx-auto mb-3 flex items-center justify-center">
                                                <i class="fas fa-box text-green-600 text-xl"></i>
                                            </div>
                                            <h3 class="font-semibold text-gray-900" x-text="product.name"></h3>
                                            <p class="text-lg font-bold text-green-600 mt-1" x-text="'‡∏ø' + product.price"></p>
                                            <p class="text-sm text-gray-500" x-text="'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ' + product.stock + ' ' + product.unit"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cart & Checkout -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-lg shadow-sm p-6 sticky top-6">
                            <h2 class="text-xl font-bold text-gray-900 mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                            
                            <!-- Cart Items -->
                            <div class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                                <template x-for="(item, index) in posCart" :key="index">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex-1">
                                            <h4 class="font-medium" x-text="item.name"></h4>
                                            <p class="text-sm text-gray-600" x-text="'‡∏ø' + item.price + ' x ' + item.quantity"></p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button @click="updateCartQuantity(index, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs">-</button>
                                            <span class="w-8 text-center" x-text="item.quantity"></span>
                                            <button @click="updateCartQuantity(index, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs">+</button>
                                        </div>
                                    </div>
                                </template>
                                
                                <div x-show="posCart.length === 0" class="text-center text-gray-500 py-8">
                                    <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                                </div>
                            </div>
                            
                            <!-- Total -->
                            <div class="border-t pt-4 mb-6">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                                    <span class="text-2xl font-bold text-green-600" x-text="'‡∏ø' + posTotal.toLocaleString()"></span>
                                </div>
                            </div>
                            
                            <!-- Payment Method -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                                <select x-model="posPaymentMethod" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                    <option value="transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                                    <option value="qr">QR PromptPay</option>
                                </select>
                            </div>
                            
                            <!-- Customer Info -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)</label>
                                <input type="text" x-model="posCustomerName" 
                                       class="w-full p-2 border border-gray-300 rounded-lg" 
                                       placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="space-y-3">
                                <button @click="processPOSSale()" :disabled="posCart.length === 0 || posProcessing"
                                        class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span x-show="!posProcessing">
                                        <i class="fas fa-cash-register mr-2"></i>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                    </span>
                                    <span x-show="posProcessing" class="flex items-center justify-center">
                                        <div class="loading mr-2"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...
                                    </span>
                                </button>
                                
                                <button @click="clearPOSCart()" :disabled="posCart.length === 0"
                                        class="w-full bg-gray-500 text-white py-2 rounded-lg font-semibold hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-trash mr-2"></i>‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Today's Sales Summary -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i class="fas fa-cash-register text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="'‡∏ø' + todaySales.toLocaleString()"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="fas fa-receipt text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏ö‡∏¥‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="todayOrders"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <i class="fas fa-chart-line text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="'‡∏ø' + (todayOrders > 0 ? (todaySales / todayOrders).toFixed(0) : 0)"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i class="fas fa-clock text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏ö‡∏¥‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                                <p class="text-lg font-bold text-gray-900" x-text="lastSaleTime"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Management Tab -->
            <div x-show="currentTab === 'products' && !loading">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <div class="flex space-x-3">
                        <button @click="addNewProduct()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </button>
                        <button @click="refreshAllData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                </div>
                
                <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="product in products" :key="product.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="product.sku"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900" x-text="product.name"></div>
                                            <div class="text-sm text-gray-500" x-text="product.description"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="'‡∏ø' + product.price?.toLocaleString()"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="product.stock <= product.min_stock ? 'text-red-600 font-bold' : 'text-gray-900'" 
                                                  x-text="product.stock + ' ' + product.unit"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="product.category"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="product.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                                  class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                  x-text="product.active ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ä‡πâ'"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                            <button @click="editProduct(product)" class="text-blue-600 hover:text-blue-900">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button @click="toggleProductStatus(product)" class="text-yellow-600 hover:text-yellow-900">
                                                <span x-text="product.active ? '‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ä‡πâ' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ'"></span>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div x-show="currentTab === 'inventory' && !loading">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <div class="flex space-x-3">
                        <button @click="bulkStockAdjustment()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-edit mr-2"></i>‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Bulk
                        </button>
                        <button @click="generateInventoryReport()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                            <i class="fas fa-file-export mr-2"></i>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
                        </button>
                    </div>
                </div>
                
                <!-- Stock Alerts -->
                <div x-show="lowStockProducts.length > 0" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <h3 class="text-red-800 font-semibold mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥
                    </h3>
                    <div class="text-red-700">
                        <template x-for="product in lowStockProducts" :key="product.id">
                            <p x-text="product.name + ' ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + product.stock + ' ' + product.unit + ' (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ' + product.min_stock + ' ' + product.unit + ')'"></p>
                        </template>
                    </div>
                </div>
                
                <!-- Inventory Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="fas fa-boxes text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="products.length"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i class="fas fa-warehouse text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏£‡∏ß‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="getTotalStock()"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="lowStockProducts.length"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i class="fas fa-dollar-sign text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="'‡∏ø' + getInventoryValue().toLocaleString()"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stock List -->
                <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="product in products" :key="product.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900" x-text="product.name"></div>
                                            <div class="text-sm text-gray-500" x-text="product.sku"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="product.stock <= product.min_stock ? 'text-red-600 font-bold' : 'text-gray-900'" 
                                                  x-text="product.stock + ' ' + product.unit"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="product.min_stock + ' ' + product.unit"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="'‡∏ø' + (product.stock * product.price).toLocaleString()"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span x-show="product.stock > product.min_stock" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                ‡∏õ‡∏Å‡∏ï‡∏¥
                                            </span>
                                            <span x-show="product.stock <= product.min_stock && product.stock > 0" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                ‡∏ï‡πà‡∏≥
                                            </span>
                                            <span x-show="product.stock === 0" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                ‡∏´‡∏°‡∏î
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button @click="adjustStock(product)" class="text-blue-600 hover:text-blue-900">‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div x-show="currentTab === 'reports' && !loading">
                <h2 class="text-xl font-bold text-gray-900 mb-6">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
                
                <!-- Date Filter -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <div class="flex flex-wrap items-end gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="date" x-model="reportDateFrom" class="p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <input type="date" x-model="reportDateTo" class="p-2 border border-gray-300 rounded-lg">
                        </div>
                        <button @click="generateSalesReport()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-search mr-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        </button>
                        <button @click="exportReport()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-download mr-2"></i>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </button>
                        <button @click="generateAdvancedReport()" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                            <i class="fas fa-chart-pie mr-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                        </button>
                    </div>
                </div>
                
                <!-- Sales Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i class="fas fa-dollar-sign text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="'‡∏ø' + reportData.totalSales.toLocaleString()"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="fas fa-receipt text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="reportData.totalOrders"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <i class="fas fa-chart-line text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="'‡∏ø' + reportData.averageOrderValue.toFixed(0)"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i class="fas fa-boxes text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="reportData.totalItems"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Products -->
                <div class="bg-white shadow-sm rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-2">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                    <th class="text-left py-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="text-left py-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢</th>
                                    <th class="text-left py-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(item, index) in reportData.topProducts" :key="item.product_id">
                                    <tr class="border-b">
                                        <td class="py-2" x-text="index + 1"></td>
                                        <td class="py-2" x-text="item.product_name"></td>
                                        <td class="py-2" x-text="item.quantity + ' ' + item.unit"></td>
                                        <td class="py-2" x-text="'‡∏ø' + item.total_sales.toLocaleString()"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
<!-- Orders Tab -->
<div x-show="currentTab === 'orders' && !loading">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-bold text-gray-900">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
    <div class="flex gap-3">
      <button @click="fetchOnlineOrders()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
        <i class="fas fa-rotate mr-2"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      </button>
    </div>
  </div>

  <div class="bg-white shadow-sm rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
            <th class="px-6 py-2 text-left text-xs font-semibold text-gray-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-200">
          <template x-for="order in onlineOrders" :key="order.id">
            <tr class="hover:bg-gray-50 align-top">
              <!-- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà -->
              <td class="px-6 py-3">
                <div class="flex flex-col space-y-1">
                  <span class="text-sm font-semibold text-gray-900" x-text="order.order_number || order.id"></span>
                  <span class="text-xs text-gray-500" x-text="formatDate(order.created_at || order.timestamp)"></span>
                </div>
              </td>

              <!-- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
              <td class="px-6 py-3">
                <div class="flex flex-col space-y-1 text-sm">
                  <span class="font-medium" x-text="order.customer?.name || order.customer_name || order.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'"></span>
                  <span class="text-gray-500" x-text="order.customer?.email || order.email || ''"></span>
                  <span class="text-gray-500" x-text="order.customer?.phone || order.phone || ''"></span>
                </div>
              </td>

              <!-- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà -->
              <td class="px-6 py-3">
                <div class="text-sm flex flex-col space-y-2">
                  <pre class="whitespace-pre-wrap leading-relaxed" x-text="formatAddress(order)"></pre>
                  <button @click="copyToClipboard(formatAddress(order))" class="self-start text-xs text-blue-600 hover:underline">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
                </div>
              </td>

              <!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
              <td class="px-6 py-3">
                <div class="text-sm flex flex-col space-y-2">
                  <span class="w-fit px-2 py-0.5 rounded-full text-xs font-semibold"
                        :class="{
                          'bg-green-100 text-green-800': (order.payment_status || '').toLowerCase()==='paid' || (order.status || '').toLowerCase()==='confirmed',
                          'bg-yellow-100 text-yellow-800': !order.payment_status || (order.payment_status || '').toLowerCase()==='pending',
                          'bg-red-100 text-red-800': (order.payment_status || '').toLowerCase()==='rejected' || (order.payment_status || '').toLowerCase()==='unpaid'
                        }"
                        x-text="(order.payment_status || order.status || 'pending')">
                  </span>
                  <span class="text-xs text-gray-500" x-text="'‡∏ß‡∏¥‡∏ò‡∏µ: ' + (order.payment_method || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')"></span>
                  <div class="flex gap-2">
                    <button @click="markPaid(order)" class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded hover:bg-green-100">‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡πà‡∏≤‡∏¢</button>
                    <button @click="markUnpaid(order)" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏Ñ‡πâ‡∏≤‡∏á</button>
                  </div>
                </div>
              </td>

              <!-- ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° -->
              <td class="px-6 py-3">
                <div class="text-sm font-semibold text-gray-900"
                     x-text="'‡∏ø' + (Number(order.total) || Number(order.total_amount) || 0).toLocaleString()">
                </div>
              </td>

              <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
              <td class="px-6 py-3">
                <div class="text-sm flex flex-col space-y-2">
                  <span class="w-fit px-2 py-0.5 rounded-full text-xs font-semibold"
                        :class="{
                          'bg-blue-100 text-blue-800': (order.status || 'pending')==='processing' || (order.status||'')==='confirmed',
                          'bg-purple-100 text-purple-800': (order.status||'')==='packed',
                          'bg-teal-100 text-teal-800': (order.status||'')==='shipped',
                          'bg-green-100 text-green-800': (order.status||'')==='delivered',
                          'bg-yellow-100 text-yellow-800': (order.status||'')==='pending',
                          'bg-red-100 text-red-800': (order.status||'')==='cancelled' || (order.status||'')==='payment_rejected'
                        }"
                        x-text="order.status || 'pending'">
                  </span>
                  <select class="text-sm border rounded px-2 py-1"
                          @change="updateOrderStatus(order, $event.target.value)">
                    <template x-for="opt in statusOptions" :key="opt">
                      <option :value="opt" :selected="(order.status || 'pending')===opt" x-text="opt"></option>
                    </template>
                  </select>
                </div>
              </td>

              <!-- ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
              <td class="px-6 py-3">
                <div class="text-sm flex flex-col space-y-2">
                  <span class="font-medium"
                        x-text="order.tracking_carrier ? (order.tracking_carrier + ' ‚Ä¢ ' + (order.tracking_number||'-')) : (order.tracking_number || '-')"></span>
                  <span class="text-xs text-gray-500" x-show="order.shipped_at" x-text="'‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + formatDate(order.shipped_at)"></span>
                  <button @click="openOrder(order)" class="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-100">‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
              </td>

              <!-- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ -->
              <td class="px-6 py-3">
                <div class="flex flex-col gap-2">
                  <button @click="openOrder(order)" class="bg-white border px-3 py-1 rounded hover:bg-gray-50 text-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                  <button @click="updateOrderStatus(order, 'delivered')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
  <div x-show="orderModalOpen" style="display:none" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40" @click="closeOrderModal()"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-xl bg-white shadow-xl overflow-y-auto">
      <div class="p-5 border-b flex items-center justify-between">
        <div>
          <h3 class="text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
          <div class="text-sm text-gray-500" x-text="selectedOrder?.order_number || selectedOrder?.id"></div>
        </div>
        <button @click="closeOrderModal()" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <div class="p-6 space-y-6">
        <!-- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
        <section class="space-y-2">
          <h4 class="font-semibold">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
          <div class="text-sm">
            <div class="font-medium" x-text="selectedOrder?.customer?.name || selectedOrder?.customer_name || selectedOrder?.name || '-'"></div>
            <div class="text-gray-600" x-text="selectedOrder?.customer?.email || selectedOrder?.email || ''"></div>
            <div class="text-gray-600" x-text="selectedOrder?.customer?.phone || selectedOrder?.phone || ''"></div>
          </div>
          <h4 class="font-semibold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h4>
          <pre class="text-sm bg-gray-50 p-3 rounded whitespace-pre-wrap" x-text="formatAddress(selectedOrder)"></pre>
          <button @click="copyToClipboard(formatAddress(selectedOrder))" class="text-xs text-blue-600 hover:underline">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
        </section>

        <!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
        <section class="space-y-2">
          <h4 class="font-semibold">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>
          <div class="flex items-center gap-2">
            <span class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
            <span class="px-2 py-0.5 rounded-full text-xs font-semibold"
                  :class="{
                    'bg-green-100 text-green-800': (selectedOrder?.payment_status || '').toLowerCase()==='paid',
                    'bg-yellow-100 text-yellow-800': !selectedOrder?.payment_status || (selectedOrder?.payment_status || '').toLowerCase()==='pending',
                    'bg-red-100 text-red-800': (selectedOrder?.payment_status || '').toLowerCase()==='rejected' || (selectedOrder?.payment_status || '').toLowerCase()==='unpaid'
                  }"
                  x-text="selectedOrder?.payment_status || 'pending'"></span>
            <span class="ml-2 text-sm text-gray-500" x-text="'‡∏ß‡∏¥‡∏ò‡∏µ: ' + (selectedOrder?.payment_method || '-')"></span>
          </div>
          <div class="flex gap-2">
            <button @click="markPaid(selectedOrder)" class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded hover:bg-green-100">‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡πà‡∏≤‡∏¢</button>
            <button @click="markUnpaid(selectedOrder)" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏Ñ‡πâ‡∏≤‡∏á</button>
          </div>
        </section>

        <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <section class="space-y-2">
          <h4 class="font-semibold">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
          <div class="text-sm border rounded overflow-hidden">
            <div class="grid grid-cols-6 bg-gray-50 px-3 py-2 font-medium">
              <div class="col-span-3">‡∏ä‡∏∑‡πà‡∏≠</div><div class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div><div class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</div><div class="text-right">‡∏£‡∏ß‡∏°</div>
            </div>
            <template x-for="(it, idx) in (selectedOrder?.items || [])" :key="idx">
              <div class="grid grid-cols-6 px-3 py-2 border-t">
                <div class="col-span-3" x-text="it.name || it.product_name"></div>
                <div class="text-right" x-text="it.quantity"></div>
                <div class="text-right" x-text="Number(it.price || 0).toLocaleString()"></div>
                <div class="text-right" x-text="Number(it.subtotal || (it.price||0)*it.quantity).toLocaleString()"></div>
              </div>
            </template>
            <div class="grid grid-cols-6 px-3 py-2 border-t bg-gray-50">
              <div class="col-span-5 text-right font-semibold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div>
              <div class="text-right font-bold" x-text="(Number(selectedOrder?.total) || Number(selectedOrder?.total_amount) || 0).toLocaleString()"></div>
            </div>
          </div>
        </section>

        <!-- ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á -->
        <section class="space-y-3">
          <h4 class="font-semibold">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h4>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm text-gray-600">‡∏Ç‡∏ô‡∏™‡πà‡∏á</label>
              <input type="text" class="w-full border rounded px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô Kerry / J&T / ‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå" x-model="carrierInput">
            </div>
            <div>
              <label class="text-sm text-gray-600">‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</label>
              <input type="text" class="w-full border rounded px-3 py-2" placeholder="‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏" x-model="trackingInput">
            </div>
          </div>
          <div class="flex gap-2">
            <button @click="saveTrackingNumber(selectedOrder)" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏</button>
            <button @click="updateOrderStatus(selectedOrder, 'shipped')" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô 'shipped'</button>
          </div>
          <div class="text-xs text-gray-500" x-show="selectedOrder?.shipped_at" x-text="'‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + formatDate(selectedOrder.shipped_at)"></div>
        </section>

        <!-- ‡∏ó‡πâ‡∏≤‡∏¢‡πÇ‡∏°‡∏î‡∏±‡∏• -->
        <div class="pt-4 border-t flex justify-between">
          <button @click="updateOrderStatus(selectedOrder, 'cancelled')" class="text-red-600 hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
          <div class="flex gap-2">
            <button @click="updateOrderStatus(selectedOrder, 'delivered')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (delivered)</button>
            <button @click="closeOrderModal()" class="bg-gray-100 px-4 py-2 rounded hover:bg-gray-200">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- /Orders Tab -->



            <!-- Contacts Tab -->
            <div x-show="currentTab === 'contacts' && !loading">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h2>
                    <button @click="refreshContacts()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
                
                <div class="space-y-4">
                    <template x-for="contact in contacts" :key="contact.id">
                        <div class="bg-white shadow-sm rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900" x-text="contact.name"></h3>
                                    <p class="text-gray-600" x-text="contact.email + ' ‚Ä¢ ' + contact.phone"></p>
                                    <p class="text-sm text-gray-500" x-text="formatDate(contact.timestamp)"></p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">‡πÉ‡∏´‡∏°‡πà</span>
                            </div>
                            <div class="text-gray-800" x-text="contact.message"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Payment Slips Tab -->
            <div x-show="currentTab === 'slips' && !loading">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h2>
                    <button @click="refreshPaymentSlips()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
                
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    <template x-for="slip in paymentSlips" :key="slip.id">
                        <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                            <div x-show="slip.file_data" class="h-48 bg-gray-100 flex items-center justify-center">
                                <img :src="'data:' + slip.file_type + ';base64,' + slip.file_data" 
                                     class="max-h-full max-w-full object-contain" alt="Payment Slip">
                            </div>
                            <div class="p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-semibold text-gray-900" x-text="slip.order_number"></h3>
                                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->
                                    <span :class="{
                                        'bg-yellow-100 text-yellow-800': !slip.status || slip.status === 'pending' || slip.verification_status === 'pending',
                                        'bg-green-100 text-green-800': slip.status === 'approved' || slip.verification_status === 'approved',
                                        'bg-red-100 text-red-800': slip.status === 'rejected' || slip.verification_status === 'rejected'
                                    }" class="px-2 py-1 rounded-full text-xs">
                                        <span x-show="!slip.status || slip.status === 'pending' || slip.verification_status === 'pending'">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                                        <span x-show="slip.status === 'approved' || slip.verification_status === 'approved'">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
                                        <span x-show="slip.status === 'rejected' || slip.verification_status === 'rejected'">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß</span>
                                    </span>
                                </div>
                                <p class="text-lg font-bold text-green-600" x-text="'‡∏ø' + slip.amount?.toLocaleString()"></p>
                                <p class="text-sm text-gray-500" x-text="formatDate(slip.uploaded_at || slip.timestamp)"></p>
                                
                                <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
                                <div class="mt-3 space-y-2">
                                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö -->
                                    <div x-show="!slip.status || slip.status === 'pending' || slip.verification_status === 'pending'" class="flex space-x-2">
                                        <button @click="approvePaymentSlip(slip)" class="flex-1 bg-green-500 text-white py-2 px-3 rounded text-sm hover:bg-green-600 transition-colors">
                                            ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                        </button>
                                        <button @click="rejectPaymentSlip(slip)" class="flex-1 bg-red-500 text-white py-2 px-3 rounded text-sm hover:bg-red-600 transition-colors">
                                            ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                                        </button>
                                    </div>
                                    
                                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß -->
                                    <div x-show="slip.status === 'approved' || slip.verification_status === 'approved'" class="text-xs text-gray-600">
                                        <p x-show="slip.approved_by">‡πÇ‡∏î‡∏¢: <span x-text="slip.approved_by"></span></p>
                                        <p x-show="slip.approved_at">‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span x-text="formatDate(slip.approved_at)"></span></p>
                                    </div>
                                    
                                    <div x-show="slip.status === 'rejected' || slip.verification_status === 'rejected'" class="text-xs text-red-600">
                                        <p x-show="slip.rejected_by">‡πÇ‡∏î‡∏¢: <span x-text="slip.rejected_by"></span></p>
                                        <p x-show="slip.rejection_reason">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: <span x-text="slip.rejection_reason"></span></p>
                                    </div>
                                    
                                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏™‡∏•‡∏¥‡∏õ (‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) -->
                                    <button @click="deletePaymentSlip(slip)" class="w-full bg-gray-500 text-white py-2 px-3 rounded text-sm hover:bg-gray-600 transition-colors">
                                        üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏•‡∏¥‡∏õ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

        </main>
    </div>

<script>
  function adminApp() {
    return {
      // ===========================
      // üõ°Ô∏è Admin Config
      // ===========================
      ADMIN_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbz_4rSRFeuwY3UQ8Ql9Herfx3UXyv7yG7-A5VV2GNZFoZoHmuP8WHGzXZjCj_68MAULJA/exec',
      SPREADSHEET_ID: '19jd3hyPBVrwvbqv28uUv47GjoPYcfVv-_1XcZH548I4',
      SHEETS_URL: 'https://docs.google.com/spreadsheets/d/19jd3hyPBVrwvbqv28uUv47GjoPYcfVv-_1XcZH548I4/edit',

      // ===========================
      // üîê Auth
      // ===========================
      isAuthenticated: false,
      userEmail: '',
      loginForm: { email: 'admin@veevee.com', password: '' },
      loginLoading: false,
      loginError: '',
      currentTab: 'orders',
      loading: false,

      // ===========================
      // üß≠ Navigation / UI State
      // ===========================
      currentTab: 'pos',
      loading: false,

      // ===========================
      // üóÇÔ∏è Data Stores
      // ===========================
      orders: [],          // ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÄ‡∏ß‡πá‡∏ö) ‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
      contacts: [],
      paymentSlips: [],
      products: [],
      posSales: [],
      allSales: [],        // ‚úÖ NEW: ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (POS + Web Orders)
      onlineOrders: [],    // ‚úÖ NEW: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Orders)

      // ===========================
      // üßæ POS State
      // ===========================
      posCart: [],
      posSearch: '',
      filteredProducts: [],
      posPaymentMethod: 'cash',
      posCustomerName: '',
      posProcessing: false,

      // ===========================
      // üìà Reports
      // ===========================
      reportDateFrom: new Date().toISOString().split('T')[0],
      reportDateTo: new Date().toISOString().split('T')[0],
      reportData: {
        totalSales: 0,
        totalOrders: 0,
        averageOrderValue: 0,
        totalItems: 0,
        topProducts: []
      },

      // ===========================
      // üßÆ Computed
      // ===========================
      get totalRevenue() {
        return this.orders.reduce((sum, order) => sum + (order.total_amount || order.total || 0), 0);
      },
      get posTotal() {
        return this.posCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      },
      get todaySales() {
        const today = new Date().toDateString();
        return this.posSales
          .filter(sale => new Date(sale.timestamp).toDateString() === today)
          .reduce((sum, sale) => sum + sale.total, 0);
      },
      get todayOrders() {
        const today = new Date().toDateString();
        return this.posSales.filter(sale => new Date(sale.timestamp).toDateString() === today).length;
      },
      get lastSaleTime() {
        if (this.posSales.length === 0) return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ';
        const lastSale = this.posSales[this.posSales.length - 1];
        return new Date(lastSale.timestamp).toLocaleTimeString('th-TH');
      },
      get lowStockProducts() {
        return this.products.filter(product => product.stock <= (product.min_stock || 0));
      },

      // ===========================
      // üöÄ Init
      // ===========================
      async init() {
        console.log('üõ°Ô∏è Admin Panel initialized');

        // ‡∏£‡∏≠ Firebase
        let retryCount = 0;
        const maxRetries = 10;
        const waitForFirebase = () => new Promise((resolve) => {
          const checkFirebase = () => {
            if (window.firebaseAuth && window.firebaseOnAuthStateChanged) {
              console.log('‚úÖ Firebase ready!');
              resolve(true);
            } else if (retryCount < maxRetries) {
              retryCount++;
              console.log(`‚è≥ Waiting for Firebase... (${retryCount}/${maxRetries})`);
              setTimeout(checkFirebase, 500);
            } else {
              console.warn('‚ö†Ô∏è Firebase timeout, continuing without auth');
              resolve(false);
            }
          };
          checkFirebase();
        });

        const firebaseReady = await waitForFirebase();

        if (firebaseReady) {
          try {
            window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
              if (user) {
                console.log('‚úÖ User authenticated:', user.email);
                this.isAuthenticated = true;
                this.userEmail = user.email;

                this.loadAllData();
                this.generateSalesReport();  // ‡πÄ‡∏Å‡πà‡∏≤ (fallback)
                // ‚úÖ NEW ‚Äî ‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° + ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                this.loadSalesReport();
                this.fetchOnlineOrders();
              } else {
                console.log('üö™ User not authenticated');
                this.isAuthenticated = false;
                this.userEmail = '';
              }
            });
          } catch (error) {
            console.error('‚ùå Auth listener error:', error);
          }
        } else {
          console.warn('‚ö†Ô∏è Running in offline mode');
        }
      },

      // ===========================
      // üîë Login/Logout
      // ===========================
      async login() {
        this.loginLoading = true;
        this.loginError = '';
        try {
          console.log('üîê Attempting login...');
          if (!window.firebaseSignInWithEmailAndPassword || !window.firebaseAuth) {
            throw new Error('Firebase Authentication ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
          }
          const userCredential = await window.firebaseSignInWithEmailAndPassword(
            window.firebaseAuth,
            this.loginForm.email,
            this.loginForm.password
          );
          console.log('‚úÖ Admin logged in:', userCredential.user.email);
          this.isAuthenticated = true;
          this.userEmail = userCredential.user.email;

          // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á Login
          setTimeout(() => {
            this.loadAllData();
            this.generateSalesReport();   // ‡πÄ‡∏î‡∏¥‡∏°
            // ‚úÖ NEW
            this.loadSalesReport();
            this.fetchOnlineOrders();
          }, 500);
        } catch (error) {
          console.error('‚ùå Login failed:', error);
          if (error.code === 'auth/user-not-found') this.loginError = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
          else if (error.code === 'auth/wrong-password') this.loginError = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          else if (error.code === 'auth/invalid-email') this.loginError = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          else this.loginError = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
        } finally {
          this.loginLoading = false;
        }
      },
      async logout() {
        try {
          if (window.firebaseSignOut && window.firebaseAuth) {
            await window.firebaseSignOut(window.firebaseAuth);
          }
          this.isAuthenticated = false;
          this.userEmail = '';
          console.log('‚úÖ Admin logged out');
        } catch (error) {
          console.error('‚ùå Logout failed:', error);
          this.isAuthenticated = false;
          this.userEmail = '';
        }
      },

      // ===========================
      // üîÑ Load all base data
      // ===========================
      async loadAllData() {
        this.loading = true;
        try {
          await Promise.all([
            this.refreshOrders(),
            this.refreshContacts(),
            this.refreshPaymentSlips(),
            this.refreshProducts(),
            this.refreshPOSSales()
          ]);
          this.filterProducts();
        } catch (error) {
          console.error('‚ùå Failed to load data:', error);
        } finally {
          this.loading = false;
        }
      },

      // ===========================
      // üì• Fetchers (‡πÄ‡∏î‡∏¥‡∏°)
      // ===========================
      async refreshProducts() {
        try {
          if (this.products.length === 0) {
            this.products = [
              {
                id: 'prod_001', sku: 'VV001',
                name: 'VeeVee Anti-Mosquito Patch',
                description: '‡πÅ‡∏ú‡πà‡∏ô‡πÅ‡∏õ‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡∏∏‡∏á 12 ‡∏ä‡∏¥‡πâ‡∏ô/‡∏ã‡∏≠‡∏á',
                price: 119, stock: 50, min_stock: 10,
                unit: '‡∏ã‡∏≠‡∏á', category: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', active: true
              },
              {
                id: 'prod_002', sku: 'VV002',
                name: 'VeeVee Refill Pack',
                description: '‡πÅ‡∏ú‡πà‡∏ô‡πÅ‡∏õ‡∏∞‡πÄ‡∏ï‡∏¥‡∏° 24 ‡∏ä‡∏¥‡πâ‡∏ô',
                price: 99, stock: 30, min_stock: 5,
                unit: '‡πÅ‡∏û‡πá‡∏Ñ', category: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', active: true
              },
              {
                id: 'prod_003', sku: 'VV003',
                name: 'VeeVee Family Set',
                description: '‡∏ä‡∏∏‡∏î‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß 5 ‡∏ã‡∏≠‡∏á',
                price: 499, stock: 15, min_stock: 3,
                unit: '‡∏ä‡∏∏‡∏î', category: '‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à', active: true
              }
            ];
          }
          console.log('‚úÖ Products loaded:', this.products.length);
        } catch (error) {
          console.error('‚ùå Failed to load products:', error);
        }
      },
      async refreshOrders() {
        try {
          const ordersRef = window.firebaseCollection(window.firebaseDb, 'orders');
          const q = window.firebaseQuery(ordersRef, window.firebaseOrderBy('timestamp', 'desc'));
          const querySnapshot = await window.firebaseGetDocs(q);
          this.orders = [];
          querySnapshot.forEach((doc) => {
            this.orders.push({ id: doc.id, ...doc.data() });
          });
          console.log('‚úÖ Orders loaded:', this.orders.length);
        } catch (error) {
          console.error('‚ùå Failed to load orders:', error);
        }
      },
      async refreshContacts() {
        try {
          const contactsRef = window.firebaseCollection(window.firebaseDb, 'contacts');
          const q = window.firebaseQuery(contactsRef, window.firebaseOrderBy('timestamp', 'desc'));
          const querySnapshot = await window.firebaseGetDocs(q);
          this.contacts = [];
          querySnapshot.forEach((doc) => {
            this.contacts.push({ id: doc.id, ...doc.data() });
          });
          console.log('‚úÖ Contacts loaded:', this.contacts.length);
        } catch (error) {
          console.error('‚ùå Failed to load contacts:', error);
        }
      },
      async refreshPaymentSlips() {
        try {
          const slipsRef = window.firebaseCollection(window.firebaseDb, 'payment_slips');
          const q = window.firebaseQuery(slipsRef, window.firebaseOrderBy('timestamp', 'desc'));
          const querySnapshot = await window.firebaseGetDocs(q);
          this.paymentSlips = [];
          querySnapshot.forEach((doc) => {
            this.paymentSlips.push({ id: doc.id, ...doc.data() });
          });
          console.log('‚úÖ Payment slips loaded:', this.paymentSlips.length);
        } catch (error) {
          console.error('‚ùå Failed to load payment slips:', error);
        }
      },
      async refreshPOSSales() {
        try {
          console.log('üîÑ Loading POS sales from Firebase and Google Sheets...');
          this.posSales = [];

          // 1) Firebase POS
          try {
            if (window.firebaseCollection && window.firebaseDb) {
              const salesRef = window.firebaseCollection(window.firebaseDb, 'pos_sales');
              const q = window.firebaseQuery(salesRef, window.firebaseOrderBy('timestamp', 'desc'));
              const querySnapshot = await window.firebaseGetDocs(q);
              querySnapshot.forEach((doc) => {
                this.posSales.push({ id: doc.id, ...doc.data(), source: 'firebase' });
              });
              console.log('‚úÖ Firebase POS Sales loaded:', this.posSales.length);
            }
          } catch (firebaseError) {
            console.warn('‚ö†Ô∏è Firebase load failed:', firebaseError);
          }

          // 2) Google Sheets POS
          try {
            if (this.ADMIN_SCRIPT_URL) {
              const scriptResult = await this.sendToAdminScript({
                action: 'get_pos_sales',
                date_from: null,
                date_to: null
              });
              if (scriptResult.success && scriptResult.data) {
                scriptResult.data.forEach(sale => {
                  const existingIndex = this.posSales.findIndex(s => s.sale_id === sale.sale_id);
                  if (existingIndex === -1) {
                    this.posSales.push({ ...sale, source: 'google_sheets' });
                  }
                });
                console.log('‚úÖ Google Sheets POS Sales loaded:', scriptResult.data.length);
                console.log('‚úÖ Total POS Sales (combined):', this.posSales.length);
              }
            }
          } catch (scriptError) {
            console.warn('‚ö†Ô∏è Google Sheets load failed:', scriptError);
          }

          // Sort new->old
          this.posSales.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          console.log('üìä Firebase sales:', this.posSales.filter(s => s.source === 'firebase').length);
          console.log('üìä Google Sheets sales:', this.posSales.filter(s => s.source === 'google_sheets').length);
        } catch (error) {
          console.error('‚ùå Failed to load POS sales:', error);
        }
      },

      // ===========================
      // üßæ Orders Integration (NEW)
      // ===========================
      async fetchOrders() {
        try {
          console.log('üìã Fetching orders from Firebase...');
          if (!window.firebaseDb || !window.firebaseCollection || !window.firebaseGetDocs) {
            console.warn('‚ö†Ô∏è Firebase not initialized');
            return;
          }
          const ordersRef = window.firebaseCollection(window.firebaseDb, 'orders');
          const querySnapshot = await window.firebaseGetDocs(ordersRef);

          this.orders = [];
          querySnapshot.forEach((doc) => {
            const order = doc.data();
            const paid = order.payment_status === 'paid' || order.payment_status === 'approved' || order.status === 'confirmed';
            if (paid) {
              this.orders.push({
                id: doc.id,
                order_number: order.order_number || doc.id,
                customer_name: order.customer?.name || order.customer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                customer_email: order.customer?.email || order.customer_email || '',
                customer_phone: order.customer?.phone || order.customer_phone || '',
                total: parseFloat(order.total) || parseFloat(order.total_amount) || 0,
                payment_method: order.payment_method || 'transfer',
                payment_status: order.payment_status || order.status || 'pending',
                timestamp: order.created_at || order.timestamp || new Date().toISOString(),
                type: 'web_order',
                source: 'firebase',
                items: order.items || [],
                ...order
              });
            }
          });
          console.log(`‚úÖ Fetched ${this.orders.length} orders from Firebase`);
        } catch (error) {
          console.error('‚ùå Error fetching orders:', error);
        }
      },
      async fetchOrdersFromSheets() {
        try {
          console.log('üìä Fetching orders from Google Sheets...');
          const response = await fetch(this.ADMIN_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'get_orders' })
          });
          const result = await response.json();
          if (result.success && result.data) {
            result.data.forEach(order => {
              const exists = this.orders.find(o => o.order_number === order.order_number || o.id === order.id);
              const paid = order.payment_status === 'paid' || order.payment_status === 'approved';
              if (!exists && paid) {
                this.orders.push({
                  ...order,
                  type: 'web_order',
                  source: 'google_sheets',
                  customer_name: order.customer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                  total: parseFloat(order.total) || parseFloat(order.total_amount) || 0
                });
              }
            });
            console.log(`‚úÖ Total orders (Firebase + Sheets): ${this.orders.length}`);
          }
        } catch (error) {
          console.error('‚ùå Error fetching orders from Sheets:', error);
        }
      },
      async loadSalesReport() {
        try {
          console.log('üìä === LOADING SALES REPORT ===');
          await this.refreshPOSSales();
          await this.fetchOrders();
          await this.fetchOrdersFromSheets();

          this.allSales = [
            ...this.posSales.map(sale => ({
              ...sale,
              type: 'pos_sale',
              sale_type: 'POS',
              sale_id: sale.sale_id || sale.id,
              timestamp: sale.timestamp
            })),
            ...this.orders.map(order => ({
              ...order,
              type: 'web_order',
              sale_type: '‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå',
              sale_id: order.order_number || order.id,
              timestamp: order.created_at || order.timestamp
            }))
          ];

          this.allSales.sort((a, b) => {
            const dateA = new Date(a.timestamp || a.created_at);
            const dateB = new Date(b.timestamp || b.created_at);
            return dateB - dateA;
          });

          console.log('üìä === SALES REPORT LOADED ===');
          console.log(`üì¶ POS Sales: ${this.posSales.length}`);
          console.log(`üåê Web Orders: ${this.orders.length}`);
          console.log(`üí∞ Total Sales Rows: ${this.allSales.length}`);
          console.log(`üíµ Total Amount: ‡∏ø${this.calculateTotalAmount().toLocaleString()}`);
        } catch (error) {
          console.error('‚ùå Error loading sales report:', error);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + error.message);
        }
      },
      calculateTotalAmount() {
        return this.allSales.reduce((sum, sale) => sum + (parseFloat(sale.total) || 0), 0);
      },
      getSalesByDateRange(startDate, endDate) {
        if (!startDate || !endDate) return this.allSales;
        const start = new Date(startDate); start.setHours(0,0,0,0);
        const end = new Date(endDate);     end.setHours(23,59,59,999);
        return this.allSales.filter(sale => {
          const saleDate = new Date(sale.timestamp || sale.created_at);
          return saleDate >= start && saleDate <= end;
        });
      },
      async fetchOnlineOrders() {
        try {
          console.log('üåê Fetching online orders...');
          if (!window.firebaseDb || !window.firebaseCollection || !window.firebaseGetDocs) {
            console.warn('‚ö†Ô∏è Firebase not initialized');
            return;
          }
          const ordersRef = window.firebaseCollection(window.firebaseDb, 'orders');
          const q = window.firebaseQuery(ordersRef, window.firebaseOrderBy('created_at', 'desc'));
          const querySnapshot = await window.firebaseGetDocs(q);
          this.onlineOrders = [];
          querySnapshot.forEach((doc) => this.onlineOrders.push({ id: doc.id, ...doc.data() }));
          console.log(`‚úÖ Fetched ${this.onlineOrders.length} online orders`);
        } catch (error) {
          console.error('‚ùå Error fetching online orders:', error);
        }
      },

      // ===========================
      // üí∞ Payment Slip Actions (REPLACED)
      // ===========================
      async approvePaymentSlip(slip) {
        try {
          console.log('‚úÖ Approving payment slip:', slip.id);
          const confirmation = confirm(
            `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ‡∏ø${slip.amount?.toLocaleString()}\n‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${slip.order_number}\n\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?`
          );
          if (!confirmation) return;

          // 1) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏•‡∏¥‡∏õ
          if (window.firebaseDoc && window.firebaseUpdateDoc && window.firebaseDb) {
            const slipRef = window.firebaseDoc(window.firebaseDb, 'payment_slips', slip.id);
            await window.firebaseUpdateDoc(slipRef, {
              status: 'approved',
              verification_status: 'approved',
              approved_at: new Date().toISOString(),
              approved_by: this.userEmail
            });
            console.log('üî• Slip approved in Firebase');
          }

          // 2) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô paid/confirmed
          if (slip.order_number && window.firebaseDb) {
            const ordersRef = window.firebaseCollection(window.firebaseDb, 'orders');
            const q = window.firebaseQuery(ordersRef, window.firebaseWhere('order_number', '==', slip.order_number));
            const querySnapshot = await window.firebaseGetDocs(q);
            if (!querySnapshot.empty) {
              const orderDoc = querySnapshot.docs[0];
              const orderRef = window.firebaseDoc(window.firebaseDb, 'orders', orderDoc.id);
              await window.firebaseUpdateDoc(orderRef, {
                payment_status: 'paid',
                status: 'confirmed',
                updated_at: new Date().toISOString()
              });
              console.log('üî• Order approved in Firebase:', slip.order_number);
            } else {
              console.warn('‚ö†Ô∏è Order not found in Firebase:', slip.order_number);
            }
          }

          // 3) Apps Script
          const adminResult = await this.sendToAdminScript({
            action: 'approve_slip',
            slip_id: slip.id,
            order_number: slip.order_number,
            amount: slip.amount,
            admin_notes: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Admin',
            approved_by: this.userEmail,
            approved_at: new Date().toISOString()
          });
          if (!adminResult.success) console.warn('‚ö†Ô∏è Apps Script update failed:', adminResult);

          // 4) Refresh
          await this.refreshPaymentSlips();
          await this.fetchOnlineOrders();
          await this.loadSalesReport();

          alert('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
          console.error('‚ùå Failed to approve slip:', error);
          alert('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ' + error.message);
        }
      },
      async rejectPaymentSlip(slip) {
        try {
          console.log('‚ùå Rejecting payment slip:', slip.id);
          const reason = prompt(
            `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ‡∏ø${slip.amount?.toLocaleString()}\n‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${slip.order_number}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:`
          );
          if (!reason) return;

          // 1) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏•‡∏¥‡∏õ
          if (window.firebaseDoc && window.firebaseUpdateDoc && window.firebaseDb) {
            const slipRef = window.firebaseDoc(window.firebaseDb, 'payment_slips', slip.id);
            await window.firebaseUpdateDoc(slipRef, {
              status: 'rejected',
              verification_status: 'rejected',
              rejected_at: new Date().toISOString(),
              rejected_by: this.userEmail,
              rejection_reason: reason
            });
            console.log('üî• Slip rejected in Firebase');
          }

          // 2) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô rejected/payment_rejected
          if (slip.order_number && window.firebaseDb) {
            const ordersRef = window.firebaseCollection(window.firebaseDb, 'orders');
            const q = window.firebaseQuery(ordersRef, window.firebaseWhere('order_number', '==', slip.order_number));
            const querySnapshot = await window.firebaseGetDocs(q);
            if (!querySnapshot.empty) {
              const orderDoc = querySnapshot.docs[0];
              const orderRef = window.firebaseDoc(window.firebaseDb, 'orders', orderDoc.id);
              await window.firebaseUpdateDoc(orderRef, {
                payment_status: 'rejected',
                status: 'payment_rejected',
                rejection_reason: reason,
                updated_at: new Date().toISOString()
              });
              console.log('üî• Order rejected in Firebase:', slip.order_number);
            }
          }

          // 3) Apps Script
          const adminResult = await this.sendToAdminScript({
            action: 'reject_slip',
            slip_id: slip.id,
            order_number: slip.order_number,
            amount: slip.amount,
            rejection_reason: reason,
            rejected_by: this.userEmail,
            rejected_at: new Date().toISOString()
          });
          if (!adminResult.success) console.warn('‚ö†Ô∏è Apps Script update failed:', adminResult);

          // 4) Refresh
          await this.refreshPaymentSlips();
          await this.fetchOnlineOrders();
          await this.loadSalesReport();

          alert('‚úÖ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
          console.error('‚ùå Failed to reject slip:', error);
          alert('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: ' + error.message);
        }
      },
      async deletePaymentSlip(slip) {
        try {
          console.log('üóëÔ∏è Deleting payment slip:', slip.id);
          const confirmation = confirm(
            `‡∏•‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô?\n\n` +
            `‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${slip.order_number}\n` +
            `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ‡∏ø${slip.amount?.toLocaleString()}\n` +
            `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${slip.status || slip.verification_status || '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'}\n\n` +
            `‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ`
          );
          if (!confirmation) return;

          if (window.firebaseDoc && window.firebaseDeleteDoc && window.firebaseDb) {
            const slipRef = window.firebaseDoc(window.firebaseDb, 'payment_slips', slip.id);
            await window.firebaseDeleteDoc(slipRef);
            console.log('üî• Slip deleted from Firebase');
          }

          const adminResult = await this.sendToAdminScript({
            action: 'delete_slip',
            slip_id: slip.id,
            order_number: slip.order_number,
            amount: slip.amount,
            deleted_by: this.userEmail,
            deleted_at: new Date().toISOString(),
            reason: '‡∏•‡∏ö‡πÇ‡∏î‡∏¢ Admin'
          });
          if (!adminResult.success) console.warn('‚ö†Ô∏è Apps Script notification failed:', adminResult);

          const slipIndex = this.paymentSlips.findIndex(s => s.id === slip.id);
          if (slipIndex !== -1) this.paymentSlips.splice(slipIndex, 1);
          await this.refreshPaymentSlips();

          alert('‚úÖ ‡∏•‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
          console.error('‚ùå Failed to delete slip:', error);
          alert('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏•‡∏¥‡∏õ: ' + error.message);
        }
      },

      // ===========================
      // üß∞ Product Management
      // ===========================
      addNewProduct() {
        const name = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:'); if (!name) return;
        const price = parseFloat(prompt('‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó):') || '0');
        if (price <= 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
        const stock = parseInt(prompt('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:') || '0');
        const minStock = parseInt(prompt('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:') || '5');
        const category = prompt('‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:') || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
        const unit = prompt('‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏¥‡πâ‡∏ô, ‡∏ã‡∏≠‡∏á, ‡πÅ‡∏û‡πá‡∏Ñ):') || '‡∏ä‡∏¥‡πâ‡∏ô';

        const newProduct = {
          id: 'prod_' + Date.now(),
          sku: 'VV' + Date.now().toString().slice(-6),
          name, description: '',
          price, stock, min_stock: minStock,
          unit, category, active: true,
          created_at: new Date().toISOString()
        };
        this.products.push(newProduct);
        this.filterProducts();
        console.log('‚úÖ Product added:', newProduct);
        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ' + name);
      },
      editProduct(product) {
        const newName = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:', product.name); if (!newName) return;
        const newPrice = parseFloat(prompt('‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó):', product.price) || product.price);
        const newMinStock = parseInt(prompt('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:', product.min_stock) || product.min_stock);
        const newCategory = prompt('‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:', product.category) || product.category;

        product.name = newName;
        product.price = newPrice;
        product.min_stock = newMinStock;
        product.category = newCategory;
        product.updated_at = new Date().toISOString();

        this.filterProducts();
        console.log('‚úÖ Product updated:', product);
        alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      },
      toggleProductStatus(product) {
        const action = product.active ? '‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        const confirmation = confirm(`${action} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${product.name}"?`);
        if (confirmation) {
          product.active = !product.active;
          product.updated_at = new Date().toISOString();
          this.filterProducts();
          console.log('‚úÖ Product status changed:', product.name, 'Active:', product.active);
          alert(`${action} ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }
      },

      // ===========================
      // üè∑Ô∏è Stock
      // ===========================
      async adjustStock(product) {
        const currentStock = product.stock;
        const newStock = prompt(
          `‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${product.name}\n` +
          `‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentStock} ${product.unit}\n` +
          `‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: ${product.min_stock} ${product.unit}\n\n` +
          `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà:`,
          currentStock
        );
        if (newStock === null) return;

        const stockNumber = parseInt(newStock);
        if (isNaN(stockNumber) || stockNumber < 0) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          return;
        }

        const adjustment = stockNumber - currentStock;
        const reason = prompt('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å:', adjustment > 0 ? '‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å' : '‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å');
        if (!reason) return;

        try {
          if (window.firebaseDoc && window.firebaseUpdateDoc && window.firebaseDb) {
            try {
              const productRef = window.firebaseDoc(window.firebaseDb, 'products', product.id);
              await window.firebaseUpdateDoc(productRef, {
                stock: stockNumber,
                last_stock_update: new Date().toISOString(),
                updated_at: new Date().toISOString()
              });
              console.log('üî• Stock updated in Firebase');
            } catch (firebaseError) {
              console.warn('‚ö†Ô∏è Firebase update failed:', firebaseError);
            }
          }

          const scriptResult = await this.sendToAdminScript({
            action: 'update_stock',
            product_id: product.id,
            product_sku: product.sku,
            product_name: product.name,
            old_stock: currentStock,
            new_stock: stockNumber,
            adjustment: adjustment,
            reason: reason,
            admin: this.userEmail,
            timestamp: new Date().toISOString()
          });
          if (scriptResult.success) console.log('üìß Stock update sent to admin system');

          product.stock = stockNumber;
          product.last_stock_update = new Date().toISOString();

          if (stockNumber <= product.min_stock && stockNumber > 0) {
            alert(`‚ö†Ô∏è ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥!\n${product.name} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${stockNumber} ${product.unit} (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${product.min_stock} ${product.unit})`);
          } else {
            alert('‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          }
        } catch (error) {
          console.error('‚ùå Failed to adjust stock:', error);
          alert('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å: ' + error.message);
        }
      },
      bulkStockAdjustment() {
        const csvData = prompt(
          '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Bulk\n\n' +
          '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: SKU,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà\n' +
          '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\nVV001,100\nVV002,50\nVV003,25\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:'
        );
        if (!csvData) return;

        const lines = csvData.trim().split('\n');
        let updated = 0;
        let errors = [];
        for (const line of lines) {
          const [sku, stockStr] = line.split(',').map(s => s.trim());
          const newStock = parseInt(stockStr);
          if (!sku || isNaN(newStock) || newStock < 0) {
            errors.push(`‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${line}`);
            continue;
          }
          const product = this.products.find(p => p.sku === sku);
          if (!product) {
            errors.push(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ SKU: ${sku}`);
            continue;
          }
          product.stock = newStock;
          product.last_stock_update = new Date().toISOString();
          updated++;
        }
        let message = `‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${updated} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        if (errors.length > 0) message += `\n\n‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n${errors.join('\n')}`;
        alert(message);
        console.log('üì¶ Bulk stock update completed:', { updated, errors });
      },

      // ===========================
      // üìë Export / Reports
      // ===========================
      async exportReport() {
        try {
          console.log('üìä Exporting sales report...');
          const reportData = this.reportData;
          const dateRange = `${this.reportDateFrom} ‡∏ñ‡∏∂‡∏á ${this.reportDateTo}`;

          let csvContent = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ VeeVee\n';
          csvContent += `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${dateRange}\n`;
          csvContent += `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}\n`;
          csvContent += `‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${this.userEmail}\n\n`;

          csvContent += '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢\n';
          csvContent += `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°,${reportData.totalSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
          csvContent += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•,${reportData.totalOrders} ‡∏ö‡∏¥‡∏•\n`;
          csvContent += `‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•,${reportData.averageOrderValue.toFixed(2)} ‡∏ö‡∏≤‡∏ó\n`;
          csvContent += `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ,${reportData.totalItems} ‡∏ä‡∏¥‡πâ‡∏ô\n\n`;

          if (reportData.topProducts.length > 0) {
            csvContent += '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ\n';
            csvContent += '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢,‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢\n';
            reportData.topProducts.forEach((item, index) => {
              csvContent += `${index + 1},${item.product_name},${item.quantity} ${item.unit},${item.total_sales.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            });
          }

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `VeeVee-Sales-Report-${this.reportDateFrom}-${this.reportDateTo}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          console.log('‚úÖ Report exported successfully');
          alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
          console.error('‚ùå Export failed:', error);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + error.message);
        }
      },
      async generateAdvancedReport() {
        const reportType = prompt(
          '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:\n\n' +
          '1 = ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô\n' +
          '2 = ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n' +
          '3 = ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤\n' +
          '4 = ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô\n\n' +
          '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç (1-4):',
          '1'
        );
        switch (reportType) {
          case '1': this.generateDailySalesReport(); break;
          case '2': this.generateInventoryReport(); break;
          case '3': alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ'); break;
          case '4': alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£-‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ'); break;
          default: alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
      },
      generateInventoryReport() {
        console.log('üì¶ Generating inventory report...');
        let csvContent = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ VeeVee\n';
        csvContent += `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}\n`;
        csvContent += `‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${this.userEmail}\n\n`;

        csvContent += '‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n';
        csvContent += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${this.products.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
        csvContent += `‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°,${this.getTotalStock()} ‡∏ä‡∏¥‡πâ‡∏ô\n`;
        csvContent += `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å,${this.getInventoryValue().toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
        csvContent += `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥,${this.lowStockProducts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n`;

        csvContent += '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n';
        csvContent += 'SKU,‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤,‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô,‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n';
        this.products.forEach(product => {
          const value = product.stock * product.price;
          const status = product.stock <= product.min_stock ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥';
          csvContent += `${product.sku},${product.name},${product.stock} ${product.unit},${product.min_stock} ${product.unit},${product.price.toLocaleString()},${value.toLocaleString()},${status}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `VeeVee-Inventory-Report-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      },
      generateDailySalesReport() {
        console.log('üìä Generating daily sales report...');
        const dailySales = {};
        // ‡πÉ‡∏ä‡πâ allSales ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        const source = (this.allSales && this.allSales.length > 0) ? this.allSales : this.posSales;
        source.forEach(sale => {
          const date = new Date(sale.timestamp || sale.created_at).toISOString().split('T')[0];
          if (!dailySales[date]) dailySales[date] = { orders: 0, total: 0, items: 0 };
          dailySales[date].orders += 1;
          dailySales[date].total += Number(sale.total || 0);
          dailySales[date].items += Array.isArray(sale.items)
            ? sale.items.reduce((n, it) => n + (Number(it.quantity) || 0), 0)
            : 0;
        });

        let csvContent = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô VeeVee\n';
        csvContent += `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}\n`;
        csvContent += `‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${this.userEmail}\n\n`;
        csvContent += '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•,‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢,‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢,‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢\n';
        Object.keys(dailySales).sort().forEach(date => {
          const data = dailySales[date];
          const avg = data.orders > 0 ? (data.total / data.orders).toFixed(2) : 0;
          csvContent += `${date},${data.orders},${data.total.toLocaleString()},${data.items},${avg}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `VeeVee-Daily-Sales-Report-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      },

      // ===========================
      // üõ†Ô∏è Utilities
      // ===========================
      async sendToAdminScript(data) {
        try {
          if (!this.ADMIN_SCRIPT_URL) {
            console.warn('‚ö†Ô∏è Admin Apps Script URL not configured');
            return { success: false, message: 'Admin system not configured' };
          }
          console.log('üì§ Sending to Admin Apps Script:', data.action);
          const response = await fetch(this.ADMIN_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...data,
              referrer: window.location.href,
              admin_auth: this.userEmail,
              timestamp: new Date().toISOString()
            }),
            mode: 'cors'
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          const result = await response.json();
          console.log('‚úÖ Admin Apps Script response:', result);
          return result;
        } catch (error) {
          console.error('‚ùå Admin Apps Script Error:', error);
          return { success: false, message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', error: error.message };
        }
      },
      async refreshAllData() {
        console.log('üîÑ Refreshing all data...');
        this.loading = true;
        try {
          await Promise.all([
            this.refreshOrders(),
            this.refreshContacts(),
            this.refreshPaymentSlips(),
            this.refreshProducts(),
            this.refreshPOSSales()
          ]);
          this.filterProducts();
          this.generateSalesReport();
          // ‚úÖ NEW
          await this.loadSalesReport();
          await this.fetchOnlineOrders();

          console.log('‚úÖ All data refreshed');
          alert('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        } catch (error) {
          console.error('‚ùå Failed to refresh data:', error);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä: ' + error.message);
        } finally {
          this.loading = false;
        }
      },

      // ===========================
      // üßæ POS
      // ===========================
      filterProducts() {
        if (!this.posSearch) {
          this.filteredProducts = this.products.filter(p => p.active && p.stock > 0);
        } else {
          const k = this.posSearch.toLowerCase();
          this.filteredProducts = this.products.filter(p =>
            p.active && p.stock > 0 &&
            (p.name.toLowerCase().includes(k) || p.sku.toLowerCase().includes(k))
          );
        }
      },
      addToCart(product) {
        if (product.stock <= 0) { alert('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å'); return; }
        const existingItem = this.posCart.find(item => item.id === product.id);
        if (existingItem) {
          if (existingItem.quantity < product.stock) existingItem.quantity++;
          else alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ');
        } else {
          this.posCart.push({
            id: product.id, name: product.name, price: product.price,
            quantity: 1, stock: product.stock, unit: product.unit
          });
        }
      },
      updateCartQuantity(index, change) {
        const item = this.posCart[index];
        const newQuantity = item.quantity + change;
        if (newQuantity <= 0) this.posCart.splice(index, 1);
        else if (newQuantity <= item.stock) item.quantity = newQuantity;
        else alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ');
      },
      clearPOSCart() { this.posCart = []; },
      async processPOSSale() {
        if (this.posCart.length === 0) return;
        this.posProcessing = true;
        try {
          const saleData = {
            sale_id: 'POS_' + Date.now(),
            items: this.posCart.map(item => ({
              product_id: item.id,
              name: item.name,
              price: item.price,
              quantity: item.quantity,
              subtotal: item.price * item.quantity
            })),
            total: this.posTotal,
            payment_method: this.posPaymentMethod,
            customer_name: this.posCustomerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
            timestamp: new Date().toISOString(),
            type: 'pos_sale'
          };

          if (window.firebaseAddDoc && window.firebaseCollection && window.firebaseDb) {
            const salesRef = window.firebaseCollection(window.firebaseDb, 'pos_sales');
            await window.firebaseAddDoc(salesRef, saleData);
            console.log('‚úÖ POS sale saved to Firebase');
          }

          const adminResult = await this.sendToAdminScript({ action: 'pos_sale', ...saleData });
          if (adminResult.success) console.log('üìß POS sale sent to admin system');

          // ‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å local
          for (const item of this.posCart) {
            const product = this.products.find(p => p.id === item.id);
            if (product) product.stock -= item.quantity;
          }
          this.clearPOSCart();
          this.posCustomerName = '';
          await this.refreshPOSSales();
          await this.loadSalesReport(); // ‚úÖ update allSales

          alert('‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ' + saleData.sale_id);
        } catch (error) {
          console.error('‚ùå POS Sale failed:', error);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: ' + error.message);
        } finally {
          this.posProcessing = false;
        }
      },

      // ===========================
      // üßÆ Helpers
      // ===========================
      getTotalStock() {
        return this.products.reduce((sum, product) => sum + product.stock, 0);
      },
      getInventoryValue() {
        return this.products.reduce((sum, product) => sum + (product.stock * product.price), 0);
      },
      // ‚úÖ REPLACED: ‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (allSales) ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      generateSalesReport() {
        const sourceSales = (this.allSales && this.allSales.length > 0)
          ? this.getSalesByDateRange(this.reportDateFrom, this.reportDateTo)
          : this.posSales.filter(sale => {
              const d = new Date(sale.timestamp);
              const from = new Date(this.reportDateFrom); from.setHours(0,0,0,0);
              const to = new Date(this.reportDateTo); to.setHours(23,59,59,999);
              return d >= from && d <= to;
            });

        const totalSales = sourceSales.reduce((sum, sale) => sum + (Number(sale.total) || 0), 0);
        const totalOrders = sourceSales.length;
        const totalItems = sourceSales.reduce((sum, sale) => {
          if (Array.isArray(sale.items)) {
            return sum + sale.items.reduce((s, it) => s + (Number(it.quantity) || 0), 0);
          }
          return sum;
        }, 0);

        const productSales = {};
        sourceSales.forEach(sale => {
          if (Array.isArray(sale.items)) {
            sale.items.forEach(item => {
              const pid = item.product_id || item.id || item.sku || item.name;
              if (!productSales[pid]) {
                productSales[pid] = {
                  product_id: pid,
                  product_name: item.name || item.product_name || pid,
                  quantity: 0,
                  total_sales: 0,
                  unit: item.unit || (this.products.find(p => p.id === item.product_id)?.unit) || '‡∏ä‡∏¥‡πâ‡∏ô'
                };
              }
              const q = Number(item.quantity) || 0;
              const sub = Number(item.subtotal) || (Number(item.price) || 0) * q;
              productSales[pid].quantity += q;
              productSales[pid].total_sales += sub;
            });
          }
        });

        const topProducts = Object.values(productSales)
          .sort((a, b) => b.total_sales - a.total_sales)
          .slice(0, 10);

        this.reportData = {
          totalSales,
          totalOrders,
          averageOrderValue: totalOrders > 0 ? totalSales / totalOrders : 0,
          totalItems,
          topProducts
        };

        console.log('üìä Sales report generated (ALL CHANNELS):', this.reportData);
      },
      openGoogleSheets() {
        if (this.SHEETS_URL) window.open(this.SHEETS_URL, '_blank');
        else alert('Google Sheets URL ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
      },
      formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp.seconds ? timestamp.seconds * 1000 : timestamp);
        return date.toLocaleDateString('th-TH') + ' ' + date.toLocaleTimeString('th-TH');
      }
    }
  }
</script>
